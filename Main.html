<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة التحليل التعليمي - النتائج</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #000000; 
            --container-color: #0a0a0a; 
            --primary-green: #00ff99;
            --primary-red: #ff4d4d;
            --primary-blue: #4d94ff;
            --primary-purple: #a64dff;
            --text-color: #e0e0e0; 
            --border-color: #00ff9930;
            --red-border-color: #ff4d4d30;
            --blue-border-color: #4d94ff30;
            --glow-shadow: 0 0 5px var(--primary-green), 0 0 10px var(--primary-green), 0 0 15px var(--primary-green);
            --red-glow-shadow: 0 0 5px var(--primary-red), 0 0 10px var(--primary-red), 0 0 15px var(--primary-red);
            --blue-glow-shadow: 0 0 5px var(--primary-blue), 0 0 10px var(--primary-blue), 0 0 15px var(--primary-blue);
            --purple-glow-shadow: 0 0 5px var(--primary-purple), 0 0 10px var(--primary-purple), 0 0 15px var(--primary-purple);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            background-color: var(--background-color); 
            color: var(--text-color); 
            font-family: 'Tajawal', sans-serif; 
            padding: 20px; 
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 153, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(77, 148, 255, 0.05) 0%, transparent 20%);
            min-height: 100vh;
        }
        
        .container { 
            width: 100%; 
            max-width: 1200px; 
            margin: 20px auto; 
            background-color: var(--container-color); 
            border-radius: 15px; 
            padding: 30px; 
            border: 1px solid var(--border-color); 
            box-shadow: 0 0 25px rgba(0, 255, 153, 0.1); 
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-blue), var(--primary-purple));
            z-index: 1;
        }
        
        /* Navigation Styles */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-green);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            color: var(--primary-blue);
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
        }
        
        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 18px;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(0, 255, 153, 0.1);
            color: var(--primary-green);
        }
        
        .nav-links a i {
            font-size: 20px;
        }
        
        /* Page Styles */
        .page {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            text-align: center;
            margin: 30px 0 50px;
            position: relative;
        }
        
        .page-header h1 {
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--primary-green);
            text-shadow: 0 0 10px rgba(0, 255, 153, 0.3);
        }
        
        .page-header p {
            font-size: 18px;
            color: #aaa;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .page-header::after {
            content: "";
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));
            border-radius: 2px;
        }
        
        /* Home Page Styles */
        #home-page .container {
            max-width: 800px;
        }
        
        #search-section { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
            position: relative;
        }
        
        #studentNumberInput { 
            flex-grow: 1; 
            padding: 15px 20px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            background-color: #1a1a1a; 
            color: #fff; 
            font-size: 16px; 
            transition: all 0.3s ease;
        }
        
        #studentNumberInput:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 10px rgba(0, 255, 153, 0.3);
        }
        
        #searchButton { 
            padding: 15px 30px; 
            border-radius: 8px; 
            border: 1px solid var(--primary-green); 
            background-color: transparent; 
            color: var(--primary-green); 
            font-size: 16px; 
            cursor: pointer; 
            transition: 0.3s; 
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        #searchButton:hover { 
            background-color: var(--primary-green); 
            color: var(--background-color); 
            box-shadow: var(--glow-shadow);
            transform: translateY(-2px);
        }
        
        #error-message { 
            color: #ff4d4d; 
            text-align: center; 
            display: none; 
            padding: 10px; 
            background: rgba(255,77,77,0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,77,77,0.3);
        }
        
        #results-container { 
            opacity: 0; 
            transform: translateY(20px); 
            transition: opacity 0.5s ease, transform 0.5s ease; 
            display: none;
        }
        
        #results-container.visible { 
            opacity: 1; 
            transform: translateY(0); 
        }
        
        .student-header { 
            text-align: center; 
            margin-bottom: 30px; 
            position: relative;
        }
        
        .student-header h2 { 
            font-size: 32px; 
            margin: 10px 0; 
            color: var(--primary-green);
            text-shadow: 0 0 10px rgba(0, 255, 153, 0.3);
        }
        
        .student-info { 
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .student-info-item { 
            background: rgba(255,255,255,0.05); 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color);
            min-width: 150px;
            text-align: center;
        }
        
        .student-info-item p { 
            margin: 5px 0; 
            color: #aaa; 
            font-size: 14px;
        }
        
        .student-info-item span { 
            font-weight: bold; 
            font-size: 18px; 
            color: var(--text-color);
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            align-items: center; 
            margin-bottom: 40px; 
        }
        
        .percentage-circle-container { 
            position: relative; 
            width: 150px; 
            height: 150px; 
            margin: auto; 
        }
        
        .percentage-circle-container.has-failure .circle-progress {
            stroke: var(--primary-red);
        }
        
        .percentage-circle-container.has-failure .percentage-text {
            color: var(--primary-red);
        }
        
        .percentage-circle-container svg { 
            width: 100%; 
            height: 100%; 
            transform: rotate(-90deg); 
        }
        
        .circle-bg { 
            fill: none; 
            stroke: #ffffff1a; 
            stroke-width: 10; 
        }
        
        .circle-progress { 
            fill: none; 
            stroke: var(--primary-green); 
            stroke-width: 10; 
            stroke-linecap: round; 
            transition: stroke-dashoffset 1s ease-out; 
        }
        
        .percentage-text { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 28px; 
            font-weight: bold; 
            color: var(--primary-green); 
        }
        
        .rank-item { 
            text-align: center; 
        }
        
        .rank-item p { 
            margin: 0; 
            font-size: 16px; 
            color: #aaa; 
            margin-bottom: 5px; 
        }
        
        .rank-item span { 
            font-size: 2.5em; 
            font-weight: bold; 
        }
        
        .rank-item .rank-normal { 
            color: var(--text-color); 
            display: block;
            font-size: 40px;
            margin: 10px 0;
        }
        
        .rank-item .rank-unique { 
            font-size: 1.2em; 
            color: #aaa; 
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .subject-bars-container h3 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: var(--primary-green); 
            font-size: 22px;
            position: relative;
            padding-bottom: 10px;
        }
        
        .subject-bars-container h3::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-green), transparent);
        }
        
        .subject-bar { 
            margin-bottom: 20px; 
        }
        
        .subject-bar-info { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5px; 
            font-size: 16px;
        }
        
        .subject-bar-info .failed-label {
            color: var(--primary-red);
            font-weight: bold;
        }
        
        .progress-bar-bg { 
            width: 100%; 
            height: 12px; 
            background-color: #ffffff1a; 
            border-radius: 6px; 
            overflow: hidden; 
        }
        
        .progress-bar-fill { 
            width: 0; 
            height: 100%; 
            background: linear-gradient(90deg, #00ff99, #00cc77); 
            border-radius: 6px; 
            transition: width 1s ease-out; 
            position: relative;
        }
        
        .progress-bar-fill.failed {
            background: linear-gradient(90deg, #ff4d4d, #cc0000) !important;
        }
        
        .progress-bar-fill::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            background-size: 200% 100%;
            animation: shine 2s infinite;
            border-radius: 6px;
        }
        
        @keyframes shine {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }
        
        #result-feedback-banner { 
            position: fixed; 
            bottom: -100px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0, 255, 153, 0.1); 
            backdrop-filter: blur(5px); 
            padding: 15px 30px; 
            border-radius: 30px; 
            border: 1px solid var(--border-color); 
            transition: bottom 0.5s ease-in-out; 
            z-index: 100; 
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        #result-feedback-banner.has-failure {
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--red-border-color);
        }
        
        #result-feedback-banner.visible { 
            bottom: 20px; 
        }
        
        .support-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Tajawal', sans-serif;
        }
        
        .support-btn:hover {
            background: #e60000;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 77, 77, 0.5);
        }
        
        #chart-container { 
            height: 300px; 
            margin-top: 40px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        #performanceChart { 
            width: 100% !important; 
            height: 100% !important; 
        }
        
        /* Analytics Page Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        
        .subject-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--blue-glow-shadow);
            border-color: var(--primary-blue);
        }
        
        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .subject-title {
            font-size: 24px;
            color: var(--primary-blue);
        }
        
        .subject-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .stat-card h4 {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .pass-fail-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .pass-stat, .fail-stat {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .pass-stat {
            background: rgba(0, 255, 153, 0.1);
            border: 1px solid var(--primary-green);
        }
        
        .fail-stat {
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--primary-red);
        }
        
        .grade-distribution {
            margin-top: 25px;
        }
        
        .grade-distribution h3 {
            margin-bottom: 15px;
            color: var(--primary-purple);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .histogram-container {
            height: 200px;
            margin-top: 15px;
        }
        
        /* About Page Styles */
        .about-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
            font-size: 18px;
        }
        
        .about-section {
            margin-bottom: 40px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        .about-section h2 {
            color: var(--primary-green);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-green);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .about-section p {
            margin-bottom: 15px;
        }
        
        .info-box {
            background: rgba(0, 255, 153, 0.1);
            border-left: 4px solid var(--primary-green);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--container-color);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 25px rgba(0, 255, 153, 0.2);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .modal-close:hover {
            color: var(--primary-red);
        }
        
        .modal-title {
            color: var(--primary-green);
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #1a1a1a;
            color: #fff;
            font-family: 'Tajawal', sans-serif;
        }
        
        .form-group input:disabled, .form-group textarea:disabled {
            background-color: #1a1a1a;
            color: #aaa;
            cursor: not-allowed;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        
        .modal-btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Tajawal', sans-serif;
        }
        
        .modal-btn.submit {
            background: var(--primary-green);
            color: #000;
            border: none;
        }
        
        .modal-btn.submit:hover {
            background: #00cc77;
            box-shadow: var(--glow-shadow);
        }
        
        .modal-btn.cancel {
            background: transparent;
            color: var(--primary-red);
            border: 1px solid var(--primary-red);
        }
        
        .modal-btn.cancel:hover {
            background: rgba(255, 77, 77, 0.1);
        }
        
        /* Stream Sections */
        .stream-section {
            margin-bottom: 50px;
        }
        
        .stream-title {
            color: var(--primary-blue);
            font-size: 28px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stream-summary-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .stream-summary-title {
            color: var(--primary-green);
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stream-summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .nav-links a {
                font-size: 16px;
                padding: 8px 12px;
            }
            
            .page-header h1 {
                font-size: 28px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .subject-card {
                padding: 20px;
            }
            
            .subject-stats {
                grid-template-columns: 1fr;
            }
            
            #result-feedback-banner {
                min-width: 250px;
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .stream-summary-stats {
                grid-template-columns: 1fr;
            }
        }
        
        .fade-out {
            animation: fadeOut 1s forwards;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; bottom: -100px; }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <span>منصة التحليل التعليمي</span>
        </div>
        <div class="nav-links">
            <a href="#home" class="nav-link active" data-page="home-page">
                <i class="fas fa-home"></i> الرئيسية
            </a>
            <a href="#analytics" class="nav-link" data-page="analytics-page">
                <i class="fas fa-chart-bar"></i> التحليلات
            </a>
            <a href="#about" class="nav-link" data-page="about-page">
                <i class="fas fa-info-circle"></i> من نحن
            </a>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="home-page" class="page active">
        <div class="container">
            <div class="page-header">
                <h1>نتائج الشهادة الثانوية - 2025</h1>
                <p>استعرض نتائجك التفصيلية، احصل على تحليل أدائك، وقارن نفسك مع زملائك في جميع المواد الدراسية</p>
            </div>
            
            <main>
                <section id="search-section">
                    <input type="number" id="studentNumberInput" placeholder="أدخل رقم القيد الخاص بك...">
                    <button id="searchButton">
                        <i class="fas fa-search"></i> بحث
                    </button>
                </section>
                <p id="error-message">لا يوجد طالب بهذا الرقم.</p>
                <div id="results-container"></div>
            </main>
        </div>
        
        <div id="result-feedback-banner" class="result-feedback-banner"></div>
    </div>

    <!-- Analytics Page -->
    <div id="analytics-page" class="page">
        <div class="container">
            <div class="page-header">
                <h1>تحليلات المواد الدراسية</h1>
                <p>استكشف أداء الطلاب في جميع المواد الدراسية، احصل على إحصائيات مفصلة وتوزيع الدرجات لكل مادة</p>
            </div>
            
            <div id="analytics-container">
                <!-- Stream sections will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- About Page -->
    <div id="about-page" class="page">
        <div class="container">
            <div class="page-header">
                <h1>عن المنصة التعليمية</h1>
                <p>تعرف على منصتنا، مصادر بياناتنا، وشروط استخدام الخدمة</p>
            </div>
            
            <div class="about-content">
                <div class="about-section">
                    <h2><i class="fas fa-file-contract"></i> شروط الخدمة</h2>
                    <p>مرحبًا بكم في منصة التحليل التعليمي. يرجى قراءة شروط الخدمة هذه بعناية قبل استخدام موقعنا.</p>
                    
                    <div class="info-box">
                        <p><strong>القبول بالشروط:</strong> باستخدامك لهذه المنصة، فإنك توافق على الالتزام بهذه الشروط والأحكام.</p>
                    </div>
                    
                    <p><strong>1. الاستخدام المسموح به:</strong> يُسمح لك باستخدام هذه المنصة لأغراض شخصية وغير تجارية فقط. لا يجوز لك استخدام محتوى المنصة لأي غرض تجاري دون الحصول على إذن كتابي مسبق منا.</p>
                    
                    <p><strong>2. دقة المعلومات:</strong> نبذل جهودًا معقولة لضمان دقة المعلومات المعروضة على المنصة، ولكننا لا نضمن اكتمالها أو دقتها أو موثوقيتها. أي اعتماد على هذه المعلومات يكون على مسؤوليتك الخاصة.</p>
                    
                    <p><strong>3. الملكية الفكرية:</strong> جميع المحتويات الموجودة على المنصة، بما في ذلك النصوص والرسومات والشعارات والصور والبرمجيات، هي ملك لنا أو لموردينا ومحمية بقوانين الملكية الفكرية.</p>
                    
                    <p><strong>4. التعديلات:</strong> نحتفظ بالحق في تعديل هذه الشروط في أي وقت. سيتم نشر أي تغييرات على هذه الصفحة، وسيكون تاريخ التحديث الأخير في أسفل الصفحة.</p>
                </div>
                
                <div class="about-section">
                    <h2><i class="fas fa-database"></i> مصدر البيانات</h2>
                    <p>تلتزم منصتنا بالشفافية فيما يتعلق بمصادر البيانات التي نعرضها:</p>
                    
                    <div class="info-box">
                        <p>جميع البيانات المعروضة على هذه المنصة تم الحصول عليها من المصادر الرسمية المعلنة من قبل وزارة التعليم.</p>
                    </div>
                    
                    <p><strong>1. المصادر الرسمية:</strong> تستند جميع البيانات المعروضة على هذه المنصة إلى المعلومات المنشورة رسميًا من قبل وزارة التعليم والجهات التابعة لها. نحن نضمن أن البيانات التي نقدمها هي نفسها المتاحة للجمهور عبر القنوات الرسمية.</p>
                    
                    <p><strong>2. تحديث البيانات:</strong> يتم تحديث البيانات بشكل دوري لضمان دقتها وحداثتها. ومع ذلك، قد يكون هناك تأخير بين نشر البيانات رسميًا وعرضها على منصتنا.</p>
                    
                    <p><strong>3. خصوصية البيانات:</strong> نحن نلتزم التزامًا تامًا بقوانين حماية البيانات وخصوصية المعلومات. لا نقوم بجمع أو تخزين أي معلومات شخصية حساسة خارج نطاق البيانات المتاحة للعموم.</p>
                    
                    <p><strong>4. الشفافية:</strong> نؤمن بحق الجمهور في الوصول إلى المعلومات التعليمية بشكل شفاف. تهدف منصتنا إلى تقديم هذه المعلومات بطريقة سهلة الفهم والاستخدام.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Request Modal -->
    <div class="modal-overlay" id="supportModal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <h2 class="modal-title">طلب دورة الدعم</h2>
            
            <form id="supportForm">
                <div class="form-group">
                    <label for="studentName">اسم الطالب</label>
                    <input type="text" id="studentName" disabled>
                </div>
                
                <div class="form-group">
                    <label for="failingSubjects">المواد الراسبة</label>
                    <textarea id="failingSubjects" rows="2" disabled></textarea>
                </div>
                
                <div class="form-group">
                    <label for="city">المدينة</label>
                    <input type="text" id="city" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">رقم الهاتف</label>
                    <input type="tel" id="phone" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="modal-btn cancel" id="cancelSupport">إلغاء</button>
                    <button type="submit" class="modal-btn submit">إرسال الطلب</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data caching objects
        const studentResultsCache = {};
        const subjectAnalyticsCache = {};
        
        let performanceChart = null;
        let feedbackTimeout = null;
        let currentPage = 'home-page';
        let studentsData = [];

        // Fetch student data from external JSON file
        async function fetchStudentData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch student data');
                }
                studentsData = await response.json();
                preCacheStudentResults();
                preCacheSubjectAnalytics();
                
                // If we're on the analytics page, refresh the display
                if (currentPage === 'analytics-page') {
                    displaySubjectAnalytics();
                }
            } catch (error) {
                console.error('Error loading student data:', error);
                // Fallback to embedded data if fetch fails
                studentsData = [
                    // Science Stream
                    { number: 1001, name: "علي محمد", stream: "علمي", grades: [ 
                        {subject:"التربية الإسلامية", score:85, maxScore:100}, 
                        {subject:"اللغة العربية", score:88, maxScore:100}, 
                        {subject:"اللغة الإنجليزية", score:92, maxScore:100}, 
                        {subject:"الرياضيات", score:45, maxScore:120},  // Failed (37.5%)
                        {subject:"الفيزياء", score:78, maxScore:100}, 
                        {subject:"الكيمياء", score:85, maxScore:100}, 
                        {subject:"الأحياء", score:90, maxScore:100}, 
                        {subject:"الميكانيكا", score:75, maxScore:90}, 
                        {subject:"تقنية المعلومات", score:88, maxScore:100} 
                    ]},
                    { number: 1002, name: "مريم حسن", stream: "علمي", grades: [ 
                        {subject:"التربية الإسلامية", score:99, maxScore:100}, 
                        {subject:"اللغة العربية", score:97, maxScore:100}, 
                        {subject:"اللغة الإنجليزية", score:96, maxScore:100}, 
                        {subject:"الرياضيات", score:118, maxScore:120}, 
                        {subject:"الفيزياء", score:94, maxScore:100}, 
                        {subject:"الكيمياء", score:98, maxScore:100}, 
                        {subject:"الأحياء", score:95, maxScore:100}, 
                        {subject:"الميكانيكا", score:88, maxScore:90}, 
                        {subject:"تقنية المعلومات", score:99, maxScore:100} 
                    ]},
                    { number: 1003, name: "أحمد جمال", stream: "علمي", grades: [ 
                        {subject:"التربية الإسلامية", score:89, maxScore:100}, 
                        {subject:"اللغة العربية", score:85, maxScore:100}, 
                        {subject:"اللغة الإنجليزية", score:90, maxScore:100}, 
                        {subject:"الرياضيات", score:105, maxScore:120}, 
                        {subject:"الفيزياء", score:80, maxScore:100}, 
                        {subject:"الكيمياء", score:85, maxScore:100}, 
                        {subject:"الأحياء", score:92, maxScore:100}, 
                        {subject:"الميكانيكا", score:82, maxScore:90}, 
                        {subject:"تقنية المعلومات", score:95, maxScore:100} 
                    ]},
                    // Literature Stream
                    { number: 2001, name: "فاطمة أحمد", stream: "أدبي", grades: [ 
                        {subject:"التربية الإسلامية", score:92, maxScore:100}, 
                        {subject:"اللغة العربية", score:95, maxScore:100}, 
                        {subject:"التاريخ", score:40, maxScore:100},  // Failed (40%)
                        {subject:"الجغرافيا", score:92, maxScore:100}, 
                        {subject:"الفلسفة", score:45, maxScore:100},  // Failed (45%)
                        {subject:"علم النفس", score:81, maxScore:90} 
                    ]},
                    { number: 2002, name: "يوسف إبراهيم", stream: "أدبي", grades: [ 
                        {subject:"التربية الإسلامية", score:98, maxScore:100}, 
                        {subject:"اللغة العربية", score:99, maxScore:100}, 
                        {subject:"التاريخ", score:95, maxScore:100}, 
                        {subject:"الجغرافيا", score:98, maxScore:100}, 
                        {subject:"الفلسفة", score:94, maxScore:100}, 
                        {subject:"علم النفس", score:88, maxScore:90} 
                    ]},
                    { number: 2003, name: "سارة خالد", stream: "أدبي", grades: [ 
                        {subject:"التربية الإسلامية", score:90, maxScore:100}, 
                        {subject:"اللغة العربية", score:92, maxScore:100}, 
                        {subject:"التاريخ", score:82, maxScore:100}, 
                        {subject:"الجغرافيا", score:85, maxScore:100}, 
                        {subject:"الفلسفة", score:78, maxScore:100}, 
                        {subject:"علم النفس", score:80, maxScore:90} 
                    ]},
                ];
                preCacheStudentResults();
                preCacheSubjectAnalytics();
            }
        }

        // Pre-cache student results
        function preCacheStudentResults() {
            // Group students by stream
            const streamGroups = {
                "علمي": [],
                "أدبي": []
            };
            
            studentsData.forEach(student => {
                streamGroups[student.stream].push(student);
            });
            
            // Calculate rankings for each stream
            Object.keys(streamGroups).forEach(stream => {
                const students = streamGroups[stream];
                
                // Calculate total and percentage for each student
                const processedStudents = students.map(student => {
                    const totalScore = student.grades.reduce((sum, g) => sum + g.score, 0);
                    const maxScore = student.grades.reduce((sum, g) => sum + g.maxScore, 0);
                    const percentage = maxScore > 0 ? (totalScore / maxScore) * 100 : 0;
                    return { ...student, totalScore, percentage };
                });
                
                // Sort students by percentage
                processedStudents.sort((a, b) => b.percentage - a.percentage);
                
                // Calculate ranks
                let normalRank = 0;
                let lastPerc = -1;
                
                processedStudents.forEach((student, index) => {
                    if (student.percentage !== lastPerc) {
                        normalRank = index + 1;
                        lastPerc = student.percentage;
                    }
                    
                    // Check for failed subjects
                    let hasFailure = false;
                    const gradesWithStatus = student.grades.map(grade => {
                        const percentage = (grade.score / grade.maxScore) * 100;
                        const failed = percentage < 50;
                        if (failed) hasFailure = true;
                        return { ...grade, failed };
                    });
                    
                    // Calculate percentile
                    const percentile = students.length > 1 ? 
                        (students.length - (index + 1)) / (students.length - 1) * 100 : 100;
                    
                    // Cache student data
                    studentResultsCache[student.number] = {
                        name: student.name,
                        number: student.number,
                        stream: student.stream,
                        percentage: student.percentage,
                        normalRank: normalRank,
                        uniqueRank: index + 1,
                        totalStudents: students.length,
                        percentile: percentile,
                        hasFailure: hasFailure,
                        grades: gradesWithStatus,
                        totalScore: student.totalScore
                    };
                });
            });
        }
        
        // Pre-cache subject analytics
        function preCacheSubjectAnalytics() {
            const subjectMap = {};
            
            // Collect all grades for each subject
            studentsData.forEach(student => {
                student.grades.forEach(grade => {
                    const subjectKey = `${grade.subject}_${student.stream}`;
                    if (!subjectMap[subjectKey]) {
                        subjectMap[subjectKey] = {
                            subjectName: grade.subject,
                            stream: student.stream,
                            scores: [],
                            maxScores: [],
                            percentages: [],
                            gradeDistribution: {
                                '50-59': 0,
                                '60-69': 0,
                                '70-79': 0,
                                '80-89': 0,
                                '90-100': 0
                            }
                        };
                    }
                    
                    const subjectData = subjectMap[subjectKey];
                    subjectData.scores.push(grade.score);
                    subjectData.maxScores.push(grade.maxScore);
                    
                    // Calculate percentage
                    const percentage = (grade.score / grade.maxScore) * 100;
                    subjectData.percentages.push(percentage);
                    
                    // Categorize into score ranges (for passing students only)
                    if (percentage >= 50) {
                        if (percentage >= 90) {
                            subjectData.gradeDistribution['90-100']++;
                        } else if (percentage >= 80) {
                            subjectData.gradeDistribution['80-89']++;
                        } else if (percentage >= 70) {
                            subjectData.gradeDistribution['70-79']++;
                        } else if (percentage >= 60) {
                            subjectData.gradeDistribution['60-69']++;
                        } else {
                            subjectData.gradeDistribution['50-59']++;
                        }
                    }
                });
            });
            
            // Calculate additional metrics
            Object.values(subjectMap).forEach(subject => {
                // Calculate average percentage
                const averagePercentage = subject.percentages.reduce((a, b) => a + b, 0) / subject.percentages.length;
                
                // Calculate pass/fail counts
                const passCount = subject.percentages.filter(p => p >= 50).length;
                const failCount = subject.percentages.length - passCount;
                
                // Calculate median score
                const sortedScores = [...subject.scores].sort((a, b) => a - b);
                const mid = Math.floor(sortedScores.length / 2);
                const medianScore = sortedScores.length % 2 !== 0 ? 
                    sortedScores[mid] : 
                    (sortedScores[mid - 1] + sortedScores[mid]) / 2;
                
                // Calculate highest and lowest scores
                const highestScore = Math.max(...subject.scores);
                const lowestScore = Math.min(...subject.scores);
                
                // Cache subject analytics
                subjectAnalyticsCache[`${subject.subjectName}_${subject.stream}`] = {
                    subjectName: subject.subjectName,
                    stream: subject.stream,
                    averagePercentage: parseFloat(averagePercentage.toFixed(1)),
                    passCount: passCount,
                    failCount: failCount,
                    medianScore: medianScore,
                    highestScore: highestScore,
                    lowestScore: lowestScore,
                    gradeDistribution: subject.gradeDistribution
                };
            });
            
            // Calculate stream summaries
            const streamSummaries = {
                "علمي": { totalStudents: 0, passingStudents: 0, failingStudents: 0, gradeDistribution: {} },
                "أدبي": { totalStudents: 0, passingStudents: 0, failingStudents: 0, gradeDistribution: {} }
            };
            
            // Initialize grade distribution categories
            Object.keys(streamSummaries).forEach(stream => {
                streamSummaries[stream].gradeDistribution = {
                    "ممتاز": 0,
                    "جيد جداً": 0,
                    "جيد": 0,
                    "مقبول": 0,
                    "ضعيف": 0
                };
            });
            
            // Process each student
            studentsData.forEach(student => {
                const stream = student.stream;
                streamSummaries[stream].totalStudents++;
                
                // Check if student has any failures
                const hasFailure = student.grades.some(grade => {
                    const percentage = (grade.score / grade.maxScore) * 100;
                    return percentage < 50;
                });
                
                if (hasFailure) {
                    streamSummaries[stream].failingStudents++;
                } else {
                    streamSummaries[stream].passingStudents++;
                }
                
                // Calculate overall percentage
                const totalScore = student.grades.reduce((sum, g) => sum + g.score, 0);
                const maxScore = student.grades.reduce((sum, g) => sum + g.maxScore, 0);
                const percentage = maxScore > 0 ? (totalScore / maxScore) * 100 : 0;
                
                // Categorize into overall grade description
                if (percentage >= 85) {
                    streamSummaries[stream].gradeDistribution["ممتاز"]++;
                } else if (percentage >= 75) {
                    streamSummaries[stream].gradeDistribution["جيد جداً"]++;
                } else if (percentage >= 65) {
                    streamSummaries[stream].gradeDistribution["جيد"]++;
                } else if (percentage >= 50) {
                    streamSummaries[stream].gradeDistribution["مقبول"]++;
                } else {
                    streamSummaries[stream].gradeDistribution["ضعيف"]++;
                }
            });
            
            // Store stream summaries
            subjectAnalyticsCache['stream_summary'] = streamSummaries;
        }
        
        // Navigation functionality
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update URL using History API
                const pageId = this.dataset.page;
                const hash = this.getAttribute('href');
                history.pushState({ page: pageId }, '', hash);
                
                // Load the page
                loadPage(pageId);
            });
        });
        
        // Handle browser navigation (back/forward buttons)
        window.addEventListener('popstate', function(event) {
            const hash = window.location.hash;
            let pageId = 'home-page';
            
            if (hash === '#analytics') pageId = 'analytics-page';
            else if (hash === '#about') pageId = 'about-page';
            
            loadPage(pageId);
        });
        
        // Load page based on ID
        function loadPage(pageId) {
            // Update active link
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active');
            
            // Show the selected page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;
            
            // Load content if needed
            if (pageId === 'analytics-page') {
                displaySubjectAnalytics();
            }
        }
        
        // Initialize routing based on URL
        function initRouting() {
            const hash = window.location.hash;
            let pageId = 'home-page';
            
            if (hash === '#analytics') pageId = 'analytics-page';
            else if (hash === '#about') pageId = 'about-page';
            
            loadPage(pageId);
        }

        // Display student results
        function displayStudentResults() {
            const studentNumber = parseInt(document.getElementById('studentNumberInput').value);
            const resultsContainer = document.getElementById('results-container');
            const errorMsg = document.getElementById('error-message');
            const feedbackBanner = document.getElementById('result-feedback-banner');
            
            // Clear any existing timeout
            if (feedbackTimeout) {
                clearTimeout(feedbackTimeout);
                feedbackTimeout = null;
            }
            
            feedbackBanner.classList.remove('visible', 'fade-out', 'has-failure');
            resultsContainer.classList.remove('visible');
            resultsContainer.style.display = 'none';

            // Check cache for student
            const studentResult = studentResultsCache[studentNumber];
            
            if (!studentResult) { 
                errorMsg.style.display = 'block'; 
                return; 
            }
            
            errorMsg.style.display = 'none';

            // Build results HTML using secure DOM methods
            resultsContainer.innerHTML = '';
            
            // Create student header
            const studentHeader = document.createElement('div');
            studentHeader.className = 'student-header';
            
            const studentName = document.createElement('h2');
            studentName.textContent = studentResult.name;
            studentHeader.appendChild(studentName);
            resultsContainer.appendChild(studentHeader);
            
            // Create student info
            const studentInfo = document.createElement('div');
            studentInfo.className = 'student-info';
            
            const infoItems = [
                { label: 'رقم القيد', value: studentResult.number },
                { label: 'المسار', value: studentResult.stream },
                { label: 'المجموع الكلي', value: studentResult.totalScore }
            ];
            
            infoItems.forEach(item => {
                const infoItem = document.createElement('div');
                infoItem.className = 'student-info-item';
                
                const label = document.createElement('p');
                label.textContent = item.label;
                infoItem.appendChild(label);
                
                const value = document.createElement('span');
                value.textContent = item.value;
                infoItem.appendChild(value);
                
                studentInfo.appendChild(infoItem);
            });
            
            resultsContainer.appendChild(studentInfo);
            
            // Create stats grid
            const statsGrid = document.createElement('div');
            statsGrid.className = 'stats-grid';
            
            // Percentage circle
            const percentageContainer = document.createElement('div');
            percentageContainer.className = `percentage-circle-container ${studentResult.hasFailure ? 'has-failure' : ''}`;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            const circleBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circleBg.setAttribute('class', 'circle-bg');
            circleBg.setAttribute('cx', '75');
            circleBg.setAttribute('cy', '75');
            circleBg.setAttribute('r', '65');
            
            const circleProgress = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circleProgress.setAttribute('id', 'circleProgress');
            circleProgress.setAttribute('class', 'circle-progress');
            circleProgress.setAttribute('cx', '75');
            circleProgress.setAttribute('cy', '75');
            circleProgress.setAttribute('r', '65');
            
            svg.appendChild(circleBg);
            svg.appendChild(circleProgress);
            percentageContainer.appendChild(svg);
            
            const percentageText = document.createElement('div');
            percentageText.id = 'percentageText';
            percentageText.className = 'percentage-text';
            percentageText.textContent = '0%';
            percentageContainer.appendChild(percentageText);
            
            const percentageLabel = document.createElement('p');
            percentageLabel.textContent = 'النسبة المئوية';
            percentageContainer.appendChild(percentageLabel);
            
            statsGrid.appendChild(percentageContainer);
            
            // Rank item
            const rankItem = document.createElement('div');
            rankItem.className = 'rank-item';
            
            const rankTitle = document.createElement('p');
            rankTitle.textContent = 'الترتيب';
            rankItem.appendChild(rankTitle);
            
            const normalRank = document.createElement('span');
            normalRank.className = 'rank-normal';
            normalRank.textContent = `#${studentResult.normalRank}`;
            rankItem.appendChild(normalRank);
            
            statsGrid.appendChild(rankItem);
            resultsContainer.appendChild(statsGrid);
            
            // Subject bars container
            const subjectBarsContainer = document.createElement('div');
            subjectBarsContainer.className = 'subject-bars-container';
            
            const subjectTitle = document.createElement('h3');
            subjectTitle.textContent = 'مستوى المواد';
            subjectBarsContainer.appendChild(subjectTitle);
            
            // Create subject bars using secure DOM methods
            studentResult.grades.forEach(grade => {
                const subjectBar = document.createElement('div');
                subjectBar.className = 'subject-bar';
                
                const subjectBarInfo = document.createElement('div');
                subjectBarInfo.className = 'subject-bar-info';
                
                const subjectName = document.createElement('span');
                subjectName.textContent = grade.subject;
                subjectBarInfo.appendChild(subjectName);
                
                const scoreInfo = document.createElement('span');
                scoreInfo.textContent = `${grade.score} / ${grade.maxScore}`;
                
                if (grade.failed) {
                    const failedLabel = document.createElement('span');
                    failedLabel.className = 'failed-label';
                    failedLabel.textContent = '(مادة راسبة)';
                    scoreInfo.appendChild(document.createTextNode(' '));
                    scoreInfo.appendChild(failedLabel);
                }
                
                subjectBarInfo.appendChild(scoreInfo);
                subjectBar.appendChild(subjectBarInfo);
                
                const progressBarBg = document.createElement('div');
                progressBarBg.className = 'progress-bar-bg';
                
                const progressBarFill = document.createElement('div');
                progressBarFill.className = `progress-bar-fill ${grade.failed ? 'failed' : ''}`;
                progressBarFill.dataset.score = grade.score;
                progressBarFill.dataset.max = grade.maxScore;
                
                progressBarBg.appendChild(progressBarFill);
                subjectBar.appendChild(progressBarBg);
                
                subjectBarsContainer.appendChild(subjectBar);
            });
            
            resultsContainer.appendChild(subjectBarsContainer);
            
            // Chart container
            const chartContainer = document.createElement('div');
            chartContainer.id = 'chart-container';
            
            const performanceCanvas = document.createElement('canvas');
            performanceCanvas.id = 'performanceChart';
            chartContainer.appendChild(performanceCanvas);
            
            resultsContainer.appendChild(chartContainer);
            
            resultsContainer.style.display = 'block';
            
            setTimeout(() => {
                resultsContainer.classList.add('visible');
                
                // Animate percentage circle
                const radius = circleProgress.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (studentResult.percentage / 100) * circumference;
                
                circleProgress.style.strokeDasharray = `${circumference} ${circumference}`;
                circleProgress.style.strokeDashoffset = offset;
                
                animateValue(percentageText, 0, studentResult.percentage, 1000, true);
                
                // Animate progress bars
                document.querySelectorAll('.progress-bar-fill').forEach(f => {
                    const percentage = (f.dataset.score / f.dataset.max) * 100;
                    f.style.width = `${percentage}%`;
                });
                
                // Conditionally show different messages based on pass/fail
                if (studentResult.hasFailure) {
                    const failedSubjects = studentResult.grades
                        .filter(grade => grade.failed)
                        .map(grade => grade.subject)
                        .join('، ');
                    
                    feedbackBanner.innerHTML = `
                        <p>لقد فشلت في مادة واحدة أو أكثر. هل ترغب في الحصول على معلومات حول دورات الدعم؟</p>
                        <button class="support-btn" id="supportButton">طلب دورة الدعم</button>
                    `;
                    feedbackBanner.classList.add('has-failure');
                    
                    // Add event listener for support button
                    document.getElementById('supportButton').addEventListener('click', () => {
                        // Fill modal with student data
                        document.getElementById('studentName').value = studentResult.name;
                        document.getElementById('failingSubjects').value = failedSubjects;
                        
                        // Show modal
                        document.getElementById('supportModal').classList.add('active');
                    });
                } else {
                    feedbackBanner.textContent = `أداؤك أفضل من ${studentResult.percentile.toFixed(0)}% من الطلاب في نفس المسار.`;
                }
                
                feedbackBanner.classList.add('visible');
                
                // Set timeout to hide the feedback banner after 10 seconds
                feedbackTimeout = setTimeout(() => {
                    feedbackBanner.classList.add('fade-out');
                }, 10000);
                
                // Create performance chart
                if (performanceChart) performanceChart.destroy();
                
                const subjectLabels = studentResult.grades.map(g => g.subject);
                const subjectData = studentResult.grades.map(g => (g.score / g.maxScore) * 100);
                
                performanceChart = new Chart(performanceCanvas, {
                    type: 'radar',
                    data: { 
                        labels: subjectLabels, 
                        datasets: [{
                            data: subjectData, 
                            backgroundColor: 'rgba(0, 255, 153, 0.2)', 
                            borderColor: 'rgb(0, 255, 153)', 
                            pointBackgroundColor: 'rgb(0, 255, 153)', 
                            pointBorderColor: '#fff',
                            borderWidth: 2,
                            pointRadius: 4
                        }] 
                    },
                    options: { 
                        maintainAspectRatio: false,
                        scales: { 
                            r: { 
                                angleLines: { color: 'rgba(255, 255, 255, 0.2)' }, 
                                grid: { color: 'rgba(255, 255, 255, 0.2)' }, 
                                pointLabels: { 
                                    color: '#e0e0e0', 
                                    font: { size: 12 } 
                                }, 
                                suggestedMin: 0, 
                                suggestedMax: 100, 
                                ticks: { 
                                    display: false,
                                    stepSize: 20
                                } 
                            } 
                        }, 
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const subjectIndex = context.dataIndex;
                                        const subject = studentResult.grades[subjectIndex];
                                        return `${subject.subject}: ${subject.score}/${subject.maxScore} (${((subject.score / subject.maxScore) * 100).toFixed(1)}%)`;
                                    }
                                }
                            }
                        } 
                    }
                });
            }, 100);
        }
        
        // Display subject analytics
        function displaySubjectAnalytics() {
            const container = document.getElementById('analytics-container');
            
            // Clear previous content
            container.innerHTML = '';
            
            // Create stream sections
            const streams = ['علمي', 'أدبي'];
            
            streams.forEach(stream => {
                // Create stream section
                const streamSection = document.createElement('div');
                streamSection.className = 'stream-section';
                
                // Stream title
                const streamTitle = document.createElement('h2');
                streamTitle.className = 'stream-title';
                streamTitle.innerHTML = `<i class="fas fa-stream"></i> مسار ${stream}`;
                streamSection.appendChild(streamTitle);
                
                // Stream summary card
                const streamSummary = subjectAnalyticsCache['stream_summary'][stream];
                
                const summaryCard = document.createElement('div');
                summaryCard.className = 'stream-summary-card';
                
                const summaryTitle = document.createElement('h3');
                summaryTitle.className = 'stream-summary-title';
                summaryTitle.innerHTML = `<i class="fas fa-chart-bar"></i> ملخص مسار ${stream}`;
                summaryCard.appendChild(summaryTitle);
                
                // Summary stats
                const summaryStats = document.createElement('div');
                summaryStats.className = 'stream-summary-stats';
                
                const stats = [
                    { label: 'عدد الطلاب الناجحين', value: streamSummary.passingStudents },
                    { label: 'عدد الطلاب الراسبين', value: streamSummary.failingStudents },
                    { label: 'إجمالي عدد الطلاب', value: streamSummary.totalStudents },
                    { label: 'نسبة النجاح', value: `${((streamSummary.passingStudents / streamSummary.totalStudents) * 100).toFixed(1)}%` }
                ];
                
                stats.forEach(stat => {
                    const statCard = document.createElement('div');
                    statCard.className = 'stat-card';
                    
                    const label = document.createElement('h4');
                    label.textContent = stat.label;
                    statCard.appendChild(label);
                    
                    const value = document.createElement('div');
                    value.className = 'value';
                    value.textContent = stat.value;
                    statCard.appendChild(value);
                    
                    summaryStats.appendChild(statCard);
                });
                
                summaryCard.appendChild(summaryStats);
                
                // Grade distribution chart
                const gradeDistribution = document.createElement('div');
                gradeDistribution.className = 'grade-distribution';
                
                const distributionTitle = document.createElement('h3');
                distributionTitle.innerHTML = '<i class="fas fa-chart-pie"></i> توزيع الدرجات الكلي';
                gradeDistribution.appendChild(distributionTitle);
                
                const histogramContainer = document.createElement('div');
                histogramContainer.className = 'histogram-container';
                
                const canvas = document.createElement('canvas');
                canvas.id = `stream-chart-${stream}`;
                histogramContainer.appendChild(canvas);
                
                gradeDistribution.appendChild(histogramContainer);
                summaryCard.appendChild(gradeDistribution);
                
                streamSection.appendChild(summaryCard);
                
                // Get subjects for this stream
                const streamSubjects = Object.values(subjectAnalyticsCache)
                    .filter(subject => subject.stream === stream)
                    .sort((a, b) => a.subjectName.localeCompare(b.subjectName));
                
                // Create subject cards grid
                const subjectsGrid = document.createElement('div');
                subjectsGrid.className = 'analytics-grid';
                
                // Create subject cards
                streamSubjects.forEach(subject => {
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'subject-card';
                    
                    // Subject header
                    const subjectHeader = document.createElement('div');
                    subjectHeader.className = 'subject-header';
                    
                    const subjectTitle = document.createElement('h3');
                    subjectTitle.className = 'subject-title';
                    subjectTitle.textContent = `${subject.subjectName} (${subject.stream})`;
                    subjectHeader.appendChild(subjectTitle);
                    
                    const averagePercentage = document.createElement('div');
                    averagePercentage.className = 'average-percentage';
                    averagePercentage.textContent = `${subject.averagePercentage}%`;
                    subjectHeader.appendChild(averagePercentage);
                    
                    subjectCard.appendChild(subjectHeader);
                    
                    // Subject stats
                    const subjectStats = document.createElement('div');
                    subjectStats.className = 'subject-stats';
                    
                    const stats = [
                        { label: 'الدرجة الأعلى', value: subject.highestScore },
                        { label: 'الدرجة الأدنى', value: subject.lowestScore },
                        { label: 'الدرجة المتوسطة', value: subject.medianScore.toFixed(1) },
                        { label: 'عدد الطلاب', value: subject.passCount + subject.failCount }
                    ];
                    
                    stats.forEach(stat => {
                        const statCard = document.createElement('div');
                        statCard.className = 'stat-card';
                        
                        const label = document.createElement('h4');
                        label.textContent = stat.label;
                        statCard.appendChild(label);
                        
                        const value = document.createElement('div');
                        value.className = 'value';
                        value.textContent = stat.value;
                        statCard.appendChild(value);
                        
                        subjectStats.appendChild(statCard);
                    });
                    
                    subjectCard.appendChild(subjectStats);
                    
                    // Pass/fail stats
                    const passFailStats = document.createElement('div');
                    passFailStats.className = 'pass-fail-stats';
                    
                    const passStat = document.createElement('div');
                    passStat.className = 'pass-stat';
                    
                    const passLabel = document.createElement('h4');
                    passLabel.textContent = 'الطلاب الناجحون';
                    passStat.appendChild(passLabel);
                    
                    const passValue = document.createElement('div');
                    passValue.className = 'value';
                    passValue.textContent = subject.passCount;
                    passStat.appendChild(passValue);
                    
                    passFailStats.appendChild(passStat);
                    
                    const failStat = document.createElement('div');
                    failStat.className = 'fail-stat';
                    
                    const failLabel = document.createElement('h4');
                    failLabel.textContent = 'الطلاب الراسبون';
                    failStat.appendChild(failLabel);
                    
                    const failValue = document.createElement('div');
                    failValue.className = 'value';
                    failValue.textContent = subject.failCount;
                    failStat.appendChild(failValue);
                    
                    passFailStats.appendChild(failStat);
                    subjectCard.appendChild(passFailStats);
                    
                    // Grade distribution
                    const gradeDistribution = document.createElement('div');
                    gradeDistribution.className = 'grade-distribution';
                    
                    const distributionTitle = document.createElement('h3');
                    distributionTitle.innerHTML = '<i class="fas fa-chart-pie"></i> توزيع درجات الناجحين';
                    gradeDistribution.appendChild(distributionTitle);
                    
                    const histogramContainer = document.createElement('div');
                    histogramContainer.className = 'histogram-container';
                    
                    const canvas = document.createElement('canvas');
                    canvas.id = `chart-${subject.subjectName}-${subject.stream}`;
                    histogramContainer.appendChild(canvas);
                    
                    gradeDistribution.appendChild(histogramContainer);
                    subjectCard.appendChild(gradeDistribution);
                    
                    subjectsGrid.appendChild(subjectCard);
                });
                
                streamSection.appendChild(subjectsGrid);
                container.appendChild(streamSection);
                
                // Create charts after DOM insertion
                setTimeout(() => {
                    // Stream summary chart
                    const streamCtx = document.getElementById(`stream-chart-${stream}`).getContext('2d');
                    
                    // Convert the grade distribution to arrays for Chart.js
                    const streamLabels = Object.keys(streamSummary.gradeDistribution);
                    const streamData = Object.values(streamSummary.gradeDistribution);
                    
                    // Create the chart
                    new Chart(streamCtx, {
                        type: 'bar',
                        data: {
                            labels: streamLabels,
                            datasets: [{
                                label: 'عدد الطلاب',
                                data: streamData,
                                backgroundColor: [
                                    'rgba(0, 255, 153, 0.7)',
                                    'rgba(77, 148, 255, 0.7)',
                                    'rgba(166, 77, 255, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(255, 99, 132, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(0, 255, 153, 1)',
                                    'rgba(77, 148, 255, 1)',
                                    'rgba(166, 77, 255, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(255, 99, 132, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#aaa'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#aaa'
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                    
                    // Subject charts
                    streamSubjects.forEach(subject => {
                        const ctx = document.getElementById(`chart-${subject.subjectName}-${subject.stream}`).getContext('2d');
                        
                        // Convert the grade distribution to arrays for Chart.js
                        const labels = ['50-59', '60-69', '70-79', '80-89', '90-100'];
                        const data = [
                            subject.gradeDistribution['50-59'],
                            subject.gradeDistribution['60-69'],
                            subject.gradeDistribution['70-79'],
                            subject.gradeDistribution['80-89'],
                            subject.gradeDistribution['90-100']
                        ];
                        
                        // Create the chart
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'عدد الطلاب',
                                    data: data,
                                    backgroundColor: [
                                        'rgba(0, 255, 153, 0.7)',
                                        'rgba(77, 148, 255, 0.7)',
                                        'rgba(166, 77, 255, 0.7)',
                                        'rgba(255, 206, 86, 0.7)',
                                        'rgba(255, 99, 132, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(0, 255, 153, 1)',
                                        'rgba(77, 148, 255, 1)',
                                        'rgba(166, 77, 255, 1)',
                                        'rgba(255, 206, 86, 1)',
                                        'rgba(255, 99, 132, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            color: '#aaa'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            color: '#aaa'
                                        },
                                        grid: {
                                            display: false
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    });
                }, 100);
            });
        }
        
        // Animate numeric values
        function animateValue(obj, start, end, duration, isPercent) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let val = isPercent ? (progress * (end - start) + start).toFixed(2) : Math.floor(progress * (end - start) + start);
                obj.textContent = isPercent ? `${val}%` : val;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // Event Listeners
        document.getElementById('searchButton').addEventListener('click', displayStudentResults);
        
        document.getElementById('studentNumberInput').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') displayStudentResults();
        });
        
        // Modal event listeners
        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('supportModal').classList.remove('active');
        });
        
        document.getElementById('cancelSupport').addEventListener('click', () => {
            document.getElementById('supportModal').classList.remove('active');
        });
        
        document.getElementById('supportForm').addEventListener('submit', (e) => {
            e.preventDefault();
            alert('تم إرسال طلبك بنجاح');
            document.getElementById('supportModal').classList.remove('active');
        });
        
        // Close modal when clicking outside
        document.getElementById('supportModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('supportModal')) {
                document.getElementById('supportModal').classList.remove('active');
            }
        });

        // Initialize the application
        window.addEventListener('DOMContentLoaded', () => {
            initRouting();
            fetchStudentData();
        });
    </script>
</body>
</html>