<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة التحليل التعليمي</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for theming */
        :root {
            --background-color: #000000; 
            --container-color: #0a0a0a; 
            --primary-green: #00ff99;
            --primary-red: #ff4d4d;
            --primary-blue: #4d94ff;
            --primary-purple: #a64dff;
            --text-color: #e0e0e0; 
            --border-color: #00ff9930;
            --red-border-color: #ff4d4d30;
            --blue-border-color: #4d94ff30;
            --glow-shadow: 0 0 5px var(--primary-green), 0 0 10px var(--primary-green), 0 0 15px var(--primary-green);
            --red-glow-shadow: 0 0 5px var(--primary-red), 0 0 10px var(--primary-red), 0 0 15px var(--primary-red);
            --blue-glow-shadow: 0 0 5px var(--primary-blue), 0 0 10px var(--primary-blue), 0 0 15px var(--primary-blue);
            --purple-glow-shadow: 0 0 5px var(--primary-purple), 0 0 10px var(--primary-purple), 0 0 15px var(--primary-purple);
        }
        
        /* General Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            background-color: var(--background-color); 
            color: var(--text-color); 
            font-family: 'Tajawal', sans-serif; 
            padding: 20px; 
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 153, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(77, 148, 255, 0.05) 0%, transparent 20%);
            min-height: 100vh;
        }
        
        .container { 
            width: 100%; 
            max-width: 1200px; 
            margin: 20px auto; 
            background-color: var(--container-color); 
            border-radius: 15px; 
            padding: 30px; 
            border: 1px solid var(--border-color); 
            box-shadow: 0 0 25px rgba(0, 255, 153, 0.1); 
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-blue), var(--primary-purple));
            z-index: 1;
        }

        /* Navbar Styles */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-green);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logo:hover {
            text-shadow: var(--glow-shadow);
        }
        
        .logo i {
            color: var(--primary-blue);
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 18px;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(0, 255, 153, 0.1);
            color: var(--primary-green);
        }
        
        /* Language Selector */
        .language-selector {
            position: relative;
        }
        
        .language-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .language-toggle:hover {
            background: rgba(0, 255, 153, 0.1);
        }
        
        .language-chevron {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .language-dropdown {
            position: absolute;
            top: 110%;
            right: 0;
            background-color: var(--container-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px;
            min-width: 120px;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        .language-dropdown.show {
            display: block;
        }
        
        .language-option {
            padding: 8px 15px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
        }
        
        .language-option:hover {
            color: var(--primary-green);
            background: rgba(0, 255, 153, 0.1);
        }
        
        /* Page & Header Styles */
        .page {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            text-align: center;
            margin: 30px 0 50px;
            position: relative;
        }
        
        .page-header h1 {
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--primary-green);
            text-shadow: 0 0 10px rgba(0, 255, 153, 0.3);
        }
        
        .page-header p {
            font-size: 18px;
            color: #aaa;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .page-header::after {
            content: "";
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-green), transparent);
            border-radius: 2px;
        }

        /* Home Page & Search */
        #search-section { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
        }
        
        #studentNumberInput { 
            flex-grow: 1; 
            padding: 15px 20px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            background-color: #1a1a1a; 
            color: #fff; 
            font-size: 16px; 
            transition: all 0.3s ease;
        }
        
        #studentNumberInput:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: var(--glow-shadow);
        }
        
        #searchButton { 
            padding: 15px 30px; 
            border-radius: 8px; 
            border: 1px solid var(--primary-green); 
            background-color: transparent; 
            color: var(--primary-green); 
            font-size: 16px; 
            cursor: pointer; 
            transition: 0.3s; 
            font-weight: bold;
        }
        
        #searchButton:hover { 
            background-color: var(--primary-green); 
            color: var(--background-color); 
            box-shadow: var(--glow-shadow);
            transform: translateY(-2px);
        }
        
        #error-message { 
            color: var(--primary-red); 
            text-align: center; 
            display: none; 
            padding: 10px; 
            background: rgba(255,77,77,0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--red-border-color);
        }
        
        /* Results Container */
        #results-container { 
            opacity: 0; 
            transform: translateY(20px); 
            transition: opacity 0.5s ease, transform 0.5s ease; 
            display: none;
        }
        
        #results-container.visible { 
            opacity: 1; 
            transform: translateY(0); 
            display: block;
        }
        
        .student-header h2 { 
            font-size: 32px; 
            color: var(--primary-green);
            text-shadow: 0 0 10px rgba(0, 255, 153, 0.3);
        }
        
        .student-info { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .student-info-item { 
            background: rgba(255,255,255,0.05); 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .student-info-item p { 
            color: #aaa; 
            font-size: 14px;
        }
        
        .student-info-item span { 
            font-weight: bold; 
            font-size: 18px; 
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            align-items: center; 
            margin: 40px 0; 
        }
        
        .percentage-circle-container { 
            position: relative; 
            width: 150px; 
            height: 150px; 
            margin: auto; 
        }
        
        .percentage-circle-container.has-failure .circle-progress { stroke: var(--primary-red); }
        .percentage-circle-container.has-failure .percentage-text { color: var(--primary-red); }
        
        .percentage-circle-container svg { 
            width: 100%; 
            height: 100%; 
            transform: rotate(-90deg); 
        }
        
        .circle-bg { fill: none; stroke: #ffffff1a; stroke-width: 10; }
        .circle-progress { 
            fill: none; 
            stroke: var(--primary-green); 
            stroke-width: 10; 
            stroke-linecap: round; 
            transition: stroke-dashoffset 1s ease-out; 
        }
        
        .percentage-text { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 28px; 
            font-weight: bold; 
        }
        
        .rank-item { text-align: center; }
        .rank-item p { font-size: 16px; color: #aaa; }
        .rank-item .rank-normal { 
            color: var(--text-color); 
            display: block;
            font-size: 40px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        /* Subject Progress Bars */
        .subject-bars-container h3 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: var(--primary-green); 
            font-size: 22px;
        }
        
        .subject-bar { margin-bottom: 15px; }
        .subject-bar-info { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .subject-bar-info .failed-label { color: var(--primary-red); font-weight: bold; }
        
        .progress-bar-bg { 
            width: 100%; 
            height: 12px; 
            background-color: #ffffff1a; 
            border-radius: 6px; 
            overflow: hidden; 
        }
        
        .progress-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #00ff99, #00cc77); 
            border-radius: 6px; 
            transition: width 1s ease-out; 
        }
        
        .progress-bar-fill.failed {
            background: linear-gradient(90deg, #ff4d4d, #cc0000);
        }
        
        /* Feedback Banner */
        #result-feedback-banner { 
            position: fixed; 
            bottom: -100px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0, 255, 153, 0.1); 
            backdrop-filter: blur(5px); 
            padding: 15px 30px; 
            border-radius: 30px; 
            border: 1px solid var(--border-color); 
            transition: all 0.5s ease-in-out; 
            z-index: 100; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 300px;
            opacity: 0;
            visibility: hidden;
        }
        
        #result-feedback-banner.has-failure {
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--red-border-color);
        }
        
        #result-feedback-banner.visible { 
            bottom: 20px; 
            opacity: 1;
            visibility: visible;
        }

        .fade-out { animation: fadeOut 1s forwards; }
        @keyframes fadeOut {
            to { opacity: 0; bottom: -100px; visibility: hidden; }
        }
        
        .support-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .support-btn:hover {
            background: #e60000;
            transform: scale(1.05);
            box-shadow: var(--red-glow-shadow);
        }
        
        #chart-container { 
            height: 350px; 
            margin-top: 40px;
            padding: 15px;
        }
        
        /* Analytics Page */
        .stream-section { margin-bottom: 50px; }
        .stream-title {
            color: var(--primary-blue);
            font-size: 28px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--blue-border-color);
        }
        
        .stream-summary-card, .subject-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--blue-glow-shadow);
            border-color: var(--primary-blue);
        }
        
        .stream-summary-title, .subject-title {
            color: var(--primary-green);
            font-size: 22px;
            margin-bottom: 20px;
        }
        
        .stream-summary-stats, .subject-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
        }
        
        .stat-card h4 { color: #aaa; font-size: 14px; margin-bottom: 8px; }
        .stat-card .value { font-size: 24px; font-weight: bold; }

        .pass-fail-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .pass-stat, .fail-stat { padding: 15px; border-radius: 10px; text-align: center; }
        .pass-stat { background: rgba(0, 255, 153, 0.1); }
        .fail-stat { background: rgba(255, 77, 77, 0.1); }
        
        .grade-distribution h3 { margin-bottom: 15px; color: var(--primary-purple); }
        .histogram-container { height: 250px; }
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* About Page */
        .about-section {
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
        }
        .about-section h2 { color: var(--primary-green); margin-bottom: 20px; }
        .info-box {
            background: rgba(0, 255, 153, 0.1);
            border-left: 4px solid var(--primary-green);
            padding: 15px;
            margin: 20px 0;
        }
        
        /* Dashboard */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: var(--purple-glow-shadow);
            border-color: var(--primary-purple);
        }
        .stat-box i { font-size: 40px; margin-bottom: 15px; color: var(--primary-green); }
        .stat-box h3 { font-size: 20px; margin-bottom: 10px; color: var(--primary-blue); }
        .stat-value { font-size: 32px; font-weight: bold; }
        .requests-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.05); border-radius: 15px; overflow: hidden; }
        .requests-table th, .requests-table td { padding: 15px; text-align: right; border-bottom: 1px solid var(--border-color); }
        .requests-table th { background: rgba(0, 255, 153, 0.1); color: var(--primary-green); }
        .requests-table tr:last-child td { border-bottom: none; }
        .requests-table tr:hover { background: rgba(0, 255, 153, 0.05); }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 14px; }
        .status-new { background: rgba(0, 255, 153, 0.2); color: var(--primary-green); }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--container-color); border-radius: 15px; padding: 30px; border: 1px solid var(--border-color); position: relative; max-width: 90%; width: 500px; }
        .modal-close { position: absolute; top: 15px; left: 15px; background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; }
        .modal-title { color: var(--primary-green); margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #aaa; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #1a1a1a; color: #fff; }
        .form-group input:disabled, .form-group textarea:disabled { background-color: #2a2a2a; color: #888; }
        .form-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
        .modal-btn { padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; border: none; }
        .modal-btn.submit { background: var(--primary-green); color: #000; }
        .modal-btn.submit:hover { background: #00cc77; box-shadow: var(--glow-shadow); }
        .modal-btn.cancel { background: transparent; color: var(--primary-red); border: 1px solid var(--primary-red); }
        .modal-btn.cancel:hover { background: rgba(255, 77, 77, 0.1); }
        .password-form { text-align: center; }
        .password-input { display: flex; gap: 10px; margin: 20px 0; }
        .password-input input { flex-grow: 1; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); background: #1a1a1a; color: #fff; }
        .password-btn { padding: 15px 30px; border-radius: 8px; background: var(--primary-green); color: #000; border: none; font-weight: bold; cursor: pointer; }
        .error-message { color: var(--primary-red); margin-top: 10px; display: none; }

        /* Animations & Loading */
        .secret-access { animation: secretAccess 0.5s ease; }
        @keyframes secretAccess { 50% { transform: scale(1.1) rotate(5deg); } }
        .shake { animation: shake 0.5s ease; }
        @keyframes shake { 25%, 75% { transform: translateX(-10px); } 50% { transform: translateX(10px); } }
        .loading-message { text-align: center; padding: 50px; font-size: 20px; color: var(--primary-green); }
        .fa-spinner { margin-left: 10px; }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .navbar { flex-direction: column; gap: 15px; }
            .nav-links { flex-wrap: wrap; justify-content: center; gap: 10px; }
            .stats-grid, .analytics-grid, .subject-stats, .stream-summary-stats, .pass-fail-stats { grid-template-columns: 1fr; }
            .requests-table { display: block; overflow-x: auto; white-space: nowrap; }
            .password-input { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="logo" id="dashboardSecret">
            <i class="fas fa-graduation-cap"></i>
            <span data-translate-key="platformTitle">منصة التحليل التعليمي</span>
        </div>
        <div class="nav-links">
            <a href="#home" class="nav-link active" data-page="home-page"><i class="fas fa-home"></i> <span data-translate-key="home">الرئيسية</span></a>
            <a href="#analytics" class="nav-link" data-page="analytics-page"><i class="fas fa-chart-bar"></i> <span data-translate-key="analytics">التحليلات</span></a>
            <a href="#about" class="nav-link" data-page="about-page"><i class="fas fa-info-circle"></i> <span data-translate-key="about">من نحن</span></a>
            <div class="language-selector">
                <div class="language-toggle" id="languageToggle">
                    <span class="language-icon">🌐</span>
                    <span class="language-code">AR</span>
                    <i class="fas fa-chevron-down language-chevron"></i>
                </div>
                <div class="language-dropdown" id="languageDropdown">
                    <div class="language-option" data-lang="en">English</div>
                    <div class="language-option" data-lang="tr">Türkçe</div>
                    <div class="language-option" data-lang="ar">العربية</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Pages -->
    <div id="home-page" class="page active">
        <div class="container">
            <div class="page-header">
                <h1 data-translate-key="resultsTitle">نتائج الشهادة الثانوية - 2025</h1>
                <p data-translate-key="resultsSubtitle">استعرض نتائجك التفصيلية، احصل على تحليل أدائك، وقارن نفسك مع زملائك.</p>
            </div>
            <main>
                <section id="search-section">
                    <input type="number" id="studentNumberInput" data-translate-placeholder="searchPlaceholder" placeholder="أدخل رقم القيد الخاص بك...">
                    <button id="searchButton"><i class="fas fa-search"></i> <span data-translate-key="searchButton">بحث</span></button>
                </section>
                <p id="error-message" data-translate-key="errorMessage">لا يوجد طالب بهذا الرقم.</p>
                <div id="results-container"></div>
            </main>
        </div>
    </div>

    <div id="analytics-page" class="page">
        <div class="container">
            <div class="page-header">
                <h1 data-translate-key="analyticsTitle">تحليلات المواد الدراسية</h1>
                <p data-translate-key="analyticsSubtitle">استكشف أداء الطلاب، واحصل على إحصائيات مفصلة وتوزيع الدرجات.</p>
            </div>
            <div id="analytics-container"></div>
        </div>
    </div>

    <div id="about-page" class="page">
        <div class="container">
             <div class="page-header">
                <h1 data-translate-key="aboutTitle">عن المنصة</h1>
                <p data-translate-key="aboutSubtitle">تعرف على منصتنا، مصادر بياناتنا، وشروط الخدمة.</p>
            </div>
            <div class="about-content">
                 <div class="about-section">
                    <h2><i class="fas fa-file-contract"></i> <span data-translate-key="termsTitle">شروط الخدمة</span></h2>
                    <p data-translate-key="termsIntro">مرحبًا بكم في منصة التحليل التعليمي...</p>
                </div>
                <div class="about-section">
                    <h2><i class="fas fa-database"></i> <span data-translate-key="dataTitle">مصدر البيانات</span></h2>
                    <p data-translate-key="dataIntro">تلتزم منصتنا بالشفافية...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-page" class="page">
        <div class="container">
            <div class="page-header">
                <h1 data-translate-key="dashboardTitle">لوحة التحكم</h1>
                <p data-translate-key="dashboardSubtitle">عرض إحصائيات الطلاب وطلبات الدعم.</p>
            </div>
            <div class="dashboard-stats">
                <div class="stat-box"><i class="fas fa-users"></i><h3 data-translate-key="totalStudents">إجمالي الطلاب</h3><div class="stat-value" id="total-students">...</div></div>
                <div class="stat-box"><i class="fas fa-user-graduate"></i><h3 data-translate-key="passingStudents">الناجحون</h3><div class="stat-value" id="passing-students">...</div></div>
                <div class="stat-box"><i class="fas fa-user-times"></i><h3 data-translate-key="failingStudents">الراسبون</h3><div class="stat-value" id="failing-students">...</div></div>
                <div class="stat-box"><i class="fas fa-percentage"></i><h3 data-translate-key="passRate">نسبة النجاح</h3><div class="stat-value" id="pass-rate">...</div></div>
            </div>
            <div class="subject-card">
                <h3 class="subject-title"><i class="fas fa-chart-pie"></i> <span data-translate-key="streamDistribution">توزيع الطلاب حسب المسار</span></h3>
                <div class="histogram-container" style="height: 300px;"><canvas id="streamChart"></canvas></div>
            </div>
            <div class="subject-card" style="margin-top: 30px;">
                <div class="subject-header">
                    <h3 class="subject-title"><i class="fas fa-life-ring"></i> <span data-translate-key="supportRequests">طلبات دورات الدعم</span></h3>
                    <button class="modal-btn submit" id="exportRequestsBtn"><i class="fas fa-file-export"></i> <span data-translate-key="exportData">تصدير</span></button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="requests-table">
                        <thead>
                            <tr>
                                <th data-translate-key="studentName">اسم الطالب</th>
                                <th data-translate-key="studentNumber">رقم القيد</th>
                                <th data-translate-key="failingSubjectsHeader">المواد</th>
                                <th data-translate-key="city">المدينة</th>
                                <th data-translate-key="phone">الهاتف</th>
                                <th data-translate-key="requestDate">التاريخ</th>
                                <th data-translate-key="status">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="supportRequestsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Feedback Banner -->
    <div id="result-feedback-banner"></div>

    <!-- Modals -->
    <div class="modal-overlay" id="password-modal">
        <div class="modal-content">
            <div class="password-form">
                <h2><i class="fas fa-lock"></i> <span data-translate-key="passwordTitle">لوحة التحكم</span></h2>
                <p data-translate-key="passwordDesc">هذه الصفحة للمديرين فقط. أدخل كلمة المرور.</p>
                <div class="password-input">
                    <input type="password" id="password-input" data-translate-placeholder="passwordPlaceholder" placeholder="كلمة المرور...">
                    <button class="password-btn" id="password-btn" data-translate-key="passwordButton">دخول</button>
                </div>
                <div class="error-message" id="password-error"><i class="fas fa-exclamation-circle"></i> <span data-translate-key="passwordError">كلمة مرور خاطئة.</span></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="supportModal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <h2 class="modal-title" data-translate-key="supportTitle">طلب دورة دعم</h2>
            <form id="supportForm">
                <div class="form-group"><label for="studentName" data-translate-key="studentName">اسم الطالب</label><input type="text" id="studentName" disabled></div>
                <div class="form-group"><label for="failingSubjects" data-translate-key="failingSubjectsHeader">المواد الراسبة</label><textarea id="failingSubjects" rows="2" disabled></textarea></div>
                <div class="form-group"><label for="city" data-translate-key="city">المدينة</label><input type="text" id="city" required></div>
                <div class="form-group"><label for="phone" data-translate-key="phone">رقم الهاتف</label><input type="tel" id="phone" required></div>
                <div class="form-actions">
                    <button type="button" class="modal-btn cancel" id="cancelSupport" data-translate-key="supportCancel">إلغاء</button>
                    <button type="submit" class="modal-btn submit" data-translate-key="supportSubmit">إرسال</button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ==================== EMBEDDED STUDENT DATA ====================
    const studentsData = [
        {"number":3390599,"name":"دعاء سالم الهادى التميمى","stream":"علمي","result":"ممتاز","grades":[{"subject":"التربية الإسلامية","total":"76.0 / 80.0","status":"ناجح"},{"subject":"اللغة العربية","total":"152.0 / 160.0","status":"ناجح"},{"subject":"اللغة الإنجليزية","total":"135.0 / 160.0","status":"ناجح"},{"subject":"تقنية المعلومات","total":"74.0 / 80.0","status":"ناجح"},{"subject":"الرياضيات","total":"176.0 / 200.0","status":"ناجح"},{"subject":"الإحصاء","total":"72.0 / 80.0","status":"ناجح"},{"subject":"الفيزياء","total":"160.0 / 200.0","status":"ناجح"},{"subject":"الكيمياء","total":"129.0 / 160.0","status":"ناجح"},{"subject":"الأحياء","total":"137.0 / 160.0","status":"ناجح"}]},
        {"number":3390600,"name":"علي محمد حسن","stream":"علمي","result":"دور ثان","grades":[{"subject":"التربية الإسلامية","total":"70.0 / 80.0","status":"ناجح"},{"subject":"اللغة العربية","total":"145.0 / 160.0","status":"ناجح"},{"subject":"اللغة الإنجليزية","total":"120.0 / 160.0","status":"ناجح"},{"subject":"تقنية المعلومات","total":"68.0 / 80.0","status":"ناجح"},{"subject":"الرياضيات","total":"150.0 / 200.0","status":"ناجح"},{"subject":"الإحصاء","total":"65.0 / 80.0","status":"ناجح"},{"subject":"الفيزياء","total":"85.0 / 200.0","status":"راسب"},{"subject":"الكيمياء","total":"110.0 / 160.0","status":"ناجح"},{"subject":"الأحياء","total":"130.0 / 160.0","status":"ناجح"}]},
        {"number":1120304,"name":"فاطمة أحمد عبدالله","stream":"أدبي","result":"جيد جداً","grades":[{"subject":"التربية الإسلامية","total":"75.0 / 80.0","status":"ناجح"},{"subject":"اللغة العربية","total":"140.0 / 160.0","status":"ناجح"},{"subject":"اللغة الإنجليزية","total":"130.0 / 160.0","status":"ناجح"},{"subject":"تقنية المعلومات","total":"70.0 / 80.0","status":"ناجح"},{"subject":"التاريخ","total":"160.0 / 200.0","status":"ناجح"},{"subject":"الجغرافيا","total":"170.0 / 200.0","status":"ناجح"},{"subject":"علم النفس","total":"130.0 / 160.0","status":"ناجح"},{"subject":"الفلسفة","total":"120.0 / 160.0","status":"ناجح"}]}
    ];

    // ==================== GLOBAL STATE & CACHE ====================
    let studentResultsCache = {};
    let subjectAnalyticsCache = {};
    let streamSummariesCache = {};
    let performanceChart = null;
    let streamChart = null;
    let feedbackTimeout = null;
    let currentPage = 'home-page';
    let supportRequests = JSON.parse(localStorage.getItem('supportRequests')) || [];
    let currentLanguage = localStorage.getItem('language') || 'ar';
    const DASHBOARD_PASSWORD = "admin123";

    // ==================== TRANSLATIONS ====================
    const translations = {
        'ar': {
            platformTitle: 'منصة التحليل التعليمي', home: 'الرئيسية', analytics: 'التحليلات', about: 'من نحن', searchPlaceholder: 'أدخل رقم القيد الخاص بك...', searchButton: 'بحث', errorMessage: 'لا يوجد طالب بهذا الرقم.',
            resultsTitle: 'نتائج الشهادة الثانوية - 2025', resultsSubtitle: 'استعرض نتائجك التفصيلية، احصل على تحليل أدائك، وقارن نفسك مع زملائك.',
            analyticsTitle: 'تحليلات المواد الدراسية', analyticsSubtitle: 'استكشف أداء الطلاب في جميع المواد، واحصل على إحصائيات مفصلة وتوزيع الدرجات.',
            aboutTitle: 'عن المنصة', aboutSubtitle: 'تعرف على منصتنا، مصادر بياناتنا، وشروط استخدام الخدمة.',
            termsTitle: 'شروط الخدمة', termsIntro: 'مرحبًا بكم في منصة التحليل التعليمي...', dataTitle: 'مصدر البيانات', dataIntro: 'تلتزم منصتنا بالشفافية...',
            dashboardTitle: 'لوحة التحكم', dashboardSubtitle: 'عرض إحصائيات الطلاب وطلبات الدعم',
            totalStudents: 'إجمالي الطلاب', passingStudents: 'الناجحون', failingStudents: 'الراسبون', passRate: 'نسبة النجاح',
            streamDistribution: 'توزيع الطلاب حسب المسار', supportRequests: 'طلبات دورات الدعم', studentName: 'اسم الطالب', studentNumber: 'رقم القيد', failingSubjectsHeader: 'المواد الراسبة', city: 'المدينة', phone: 'الهاتف', requestDate: 'التاريخ', status: 'الحالة', exportData: 'تصدير',
            passwordTitle: 'لوحة التحكم', passwordDesc: 'هذه الصفحة للمديرين فقط. أدخل كلمة المرور.', passwordPlaceholder: 'كلمة المرور...', passwordButton: 'دخول', passwordError: 'كلمة مرور خاطئة.',
            supportTitle: 'طلب دورة دعم', supportCancel: 'إلغاء', supportSubmit: 'إرسال',
            loadingAnalytics: 'جاري تحميل التحليلات...', streamPath: 'مسار', streamSummary: 'ملخص المسار', overallGradeDist: 'توزيع الدرجات الكلي',
            highestScore: 'أعلى درجة', lowestScore: 'أدنى درجة', medianScore: 'الدرجة الوسيطة', studentCount: 'عدد الطلاب', successfulStudentDist: 'توزيع درجات الناجحين',
            pass: 'ناجح', fail: 'راسب', result: 'النتيجة', rank: 'الترتيب', rankSubtitle: 'من أصل {total} طالب', subjectsLevel: 'مستوى المواد',
            excellent: 'ممتاز', veryGood: 'جيد جدًا', good: 'جيد', passGrade: 'مقبول', weak: 'ضعيف', statusNew: 'جديد',
            failedSubjectsMessage: 'لقد رسبت في {count} مواد. هل تود طلب دعم؟', supportRequestBtn: 'طلب دورة دعم', successMessage: 'ممتاز! لقد نجحت في جميع المواد.', supportRequestSent: 'تم إرسال طلبك بنجاح!'
        },
        'en': {
            platformTitle: 'Educational Analytics Platform', home: 'Home', analytics: 'Analytics', about: 'About', searchPlaceholder: 'Enter your student number...', searchButton: 'Search', errorMessage: 'No student found with this number.',
            resultsTitle: 'High School Results - 2025', resultsSubtitle: 'View detailed results, get performance analysis, and compare with peers.',
            analyticsTitle: 'Subject Analytics', analyticsSubtitle: 'Explore student performance, get detailed stats and grade distributions.',
            aboutTitle: 'About Us', aboutSubtitle: 'Learn about our platform, data sources, and terms of service.',
            termsTitle: 'Terms of Service', termsIntro: 'Welcome to the Educational Analytics Platform...', dataTitle: 'Data Source', dataIntro: 'We are transparent about our data sources...',
            dashboardTitle: 'Dashboard', dashboardSubtitle: 'View student statistics and support requests',
            totalStudents: 'Total Students', passingStudents: 'Passing Students', failingStudents: 'Failing Students', passRate: 'Pass Rate',
            streamDistribution: 'Distribution by Stream', supportRequests: 'Support Requests', studentName: 'Student Name', studentNumber: 'Student ID', failingSubjectsHeader: 'Failing Subjects', city: 'City', phone: 'Phone', requestDate: 'Date', status: 'Status', exportData: 'Export',
            passwordTitle: 'Secure Dashboard', passwordDesc: 'For administrators only. Please enter the password.', passwordPlaceholder: 'Password...', passwordButton: 'Login', passwordError: 'Incorrect password.',
            supportTitle: 'Support Request', supportCancel: 'Cancel', supportSubmit: 'Submit',
            loadingAnalytics: 'Loading analytics...', streamPath: 'Stream', streamSummary: 'Stream Summary', overallGradeDist: 'Overall Grade Distribution',
            highestScore: 'Highest Score', lowestScore: 'Lowest Score', medianScore: 'Median Score', studentCount: 'Student Count', successfulStudentDist: 'Passing Grades Distribution',
            pass: 'Pass', fail: 'Fail', result: 'Result', rank: 'Rank', rankSubtitle: 'out of {total} students', subjectsLevel: 'Subjects Level',
            excellent: 'Excellent', veryGood: 'Very Good', good: 'Good', passGrade: 'Pass', weak: 'Weak', statusNew: 'New',
            failedSubjectsMessage: 'You failed in {count} subjects. Request support?', supportRequestBtn: 'Request Support', successMessage: 'Excellent! You passed all subjects.', supportRequestSent: 'Your request has been sent successfully!'
        },
        'tr': {
            platformTitle: 'Eğitim Analiz Platformu', home: 'Ana Sayfa', analytics: 'Analizler', about: 'Hakkımızda', searchPlaceholder: 'Öğrenci numaranızı girin...', searchButton: 'Ara', errorMessage: 'Bu numaraya sahip öğrenci bulunamadı.',
            resultsTitle: 'Lise Sonuçları - 2025', resultsSubtitle: 'Detaylı sonuçları görüntüleyin, performans analizi alın ve akranlarınızla karşılaştırın.',
            analyticsTitle: 'Ders Analizleri', analyticsSubtitle: 'Öğrenci performansını keşfedin, detaylı istatistikler ve not dağılımları alın.',
            aboutTitle: 'Hakkımızda', aboutSubtitle: 'Platformumuz, veri kaynaklarımız ve hizmet şartlarımız hakkında bilgi edinin.',
            termsTitle: 'Hizmet Şartları', termsIntro: 'Eğitim Analiz Platformuna hoş geldiniz...', dataTitle: 'Veri Kaynağı', dataIntro: 'Veri kaynaklarımız konusunda şeffafız...',
            dashboardTitle: 'Kontrol Paneli', dashboardSubtitle: 'Öğrenci istatistiklerini ve destek taleplerini görüntüleyin',
            totalStudents: 'Toplam Öğrenci', passingStudents: 'Başarılı Öğrenci', failingStudents: 'Başarısız Öğrenci', passRate: 'Başarı Oranı',
            streamDistribution: 'Alana Göre Dağılım', supportRequests: 'Destek Talepleri', studentName: 'Öğrenci Adı', studentNumber: 'Öğrenci No', failingSubjectsHeader: 'Başarısız Dersler', city: 'Şehir', phone: 'Telefon', requestDate: 'Tarih', status: 'Durum', exportData: 'Dışa Aktar',
            passwordTitle: 'Güvenli Panel', passwordDesc: 'Yalnızca yöneticiler içindir. Lütfen şifreyi girin.', passwordPlaceholder: 'Şifre...', passwordButton: 'Giriş', passwordError: 'Yanlış şifre.',
            supportTitle: 'Destek Talebi', supportCancel: 'İptal', supportSubmit: 'Gönder',
            loadingAnalytics: 'Analizler yükleniyor...', streamPath: 'Alan', streamSummary: 'Alan Özeti', overallGradeDist: 'Genel Not Dağılımı',
            highestScore: 'En Yüksek Not', lowestScore: 'En Düşük Not', medianScore: 'Medyan Not', studentCount: 'Öğrenci Sayısı', successfulStudentDist: 'Geçme Notları Dağılımı',
            pass: 'Geçti', fail: 'Kaldı', result: 'Sonuç', rank: 'Sıralama', rankSubtitle: '{total} öğrenci içinden', subjectsLevel: 'Ders Seviyeleri',
            excellent: 'Mükemmel', veryGood: 'Çok İyi', good: 'İyi', passGrade: 'Geçer', weak: 'Zayıf', statusNew: 'Yeni',
            failedSubjectsMessage: '{count} dersten başarısız oldunuz. Destek ister misiniz?', supportRequestBtn: 'Destek Talep Et', successMessage: 'Harika! Tüm dersleri geçtiniz.', supportRequestSent: 'Talebiniz başarıyla gönderildi!'
        }
    };

    // ==================== CORE & DATA PROCESSING ====================
    function preCacheStudentResults() {
        if (Object.keys(studentResultsCache).length > 0) return;
        studentsData.forEach(student => {
            let totalScore = 0, maxScore = 0, hasFailure = false;
            const gradesWithStatus = student.grades.map(grade => {
                const [score, max] = grade.total.split('/').map(s => parseFloat(s.trim()));
                totalScore += score; maxScore += max;
                const failed = grade.status.includes("راسب") || (score / max) < 0.5;
                if (failed) hasFailure = true;
                return { subject: grade.subject, score, maxScore: max, failed };
            });
            studentResultsCache[student.number] = {
                ...student,
                percentage: maxScore > 0 ? (totalScore / maxScore) * 100 : 0,
                hasFailure, grades: gradesWithStatus, totalScore
            };
        });
        const allStudents = Object.values(studentResultsCache).sort((a, b) => b.percentage - a.percentage);
        allStudents.forEach((student, index) => {
            student.rank = index + 1;
            student.totalStudentsInRank = allStudents.length;
        });
    }

    function processAnalytics() {
        // This function replaces the external worker
        const subjectMap = {};
        studentsData.forEach(student => {
            student.grades.forEach(grade => {
                const [score, max] = grade.total.split('/').map(s => parseFloat(s.trim()));
                const percentage = (score / max) * 100;
                const key = `${grade.subject}_${student.stream}`;
                if (!subjectMap[key]) {
                    subjectMap[key] = { name: grade.subject, stream: student.stream, scores: [], percentages: [], dist: {'50-59':0,'60-69':0,'70-79':0,'80-89':0,'90-100':0}};
                }
                subjectMap[key].scores.push(score);
                subjectMap[key].percentages.push(percentage);
                if (percentage >= 50) {
                    if (percentage >= 90) subjectMap[key].dist['90-100']++;
                    else if (percentage >= 80) subjectMap[key].dist['80-89']++;
                    else if (percentage >= 70) subjectMap[key].dist['70-79']++;
                    else if (percentage >= 60) subjectMap[key].dist['60-69']++;
                    else subjectMap[key].dist['50-59']++;
                }
            });
        });

        Object.values(subjectMap).forEach(subject => {
            const sorted = [...subject.scores].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            subjectAnalyticsCache[`${subject.name}_${subject.stream}`] = {
                subjectName: subject.name, stream: subject.stream,
                averagePercentage: parseFloat((subject.percentages.reduce((a, b) => a + b, 0) / subject.percentages.length).toFixed(1)),
                passCount: subject.percentages.filter(p => p >= 50).length,
                failCount: subject.percentages.length - subject.percentages.filter(p => p >= 50).length,
                medianScore: sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2,
                highestScore: Math.max(...subject.scores), lowestScore: Math.min(...subject.scores),
                gradeDistribution: subject.dist
            };
        });

        studentsData.forEach(student => {
            const stream = student.stream;
            if (!streamSummariesCache[stream]) {
                streamSummariesCache[stream] = { total: 0, passing: 0, failing: 0, dist: { "ممتاز":0, "جيد جداً":0, "جيد":0, "مقبول":0, "ضعيف":0 }};
            }
            streamSummariesCache[stream].total++;
            const studentCache = studentResultsCache[student.number];
            if (studentCache.hasFailure) streamSummariesCache[stream].failing++;
            else streamSummariesCache[stream].passing++;
            
            const p = studentCache.percentage;
            if (p >= 85) streamSummariesCache[stream].dist["ممتاز"]++;
            else if (p >= 75) streamSummariesCache[stream].dist["جيد جداً"]++;
            else if (p >= 65) streamSummariesCache[stream].dist["جيد"]++;
            else if (p >= 50) streamSummariesCache[stream].dist["مقبول"]++;
            else streamSummariesCache[stream].dist["ضعيف"]++;
        });
    }

    // ==================== UI & RENDERING ====================
    function updateLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
        document.querySelector('.language-code').textContent = lang.toUpperCase();
        document.getElementById('languageDropdown').classList.remove('show');
        
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (translations[lang][key]) el.innerHTML = translations[lang][key];
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.getAttribute('data-translate-placeholder');
            if (translations[lang][key]) el.placeholder = translations[lang][key];
        });

        if (currentPage === 'analytics-page') displaySubjectAnalytics();
        if (currentPage === 'dashboard-page') updateDashboard();
    }

    function loadPage(pageId) {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const navLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
        if (navLink) navLink.classList.add('active');

        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        currentPage = pageId;

        if (pageId === 'analytics-page') displaySubjectAnalytics();
        else if (pageId === 'dashboard-page') updateDashboard();
    }

    function displayStudentResults() {
        const studentNumber = parseInt(document.getElementById('studentNumberInput').value);
        const resultsContainer = document.getElementById('results-container');
        const errorMsg = document.getElementById('error-message');
        
        resultsContainer.classList.remove('visible');
        errorMsg.style.display = 'none';

        const student = studentResultsCache[studentNumber];
        if (!student) {
            errorMsg.style.display = 'block';
            return;
        }

        const t = translations[currentLanguage];
        resultsContainer.innerHTML = `
            <div class="student-header"><h2>${student.name}</h2></div>
            <div class="student-info">
                <div class="student-info-item"><p>${t.studentNumber}</p><span>${student.number}</span></div>
                <div class="student-info-item"><p>${t.streamPath}</p><span>${student.stream}</span></div>
                <div class="student-info-item"><p>${t.result}</p><span>${student.result}</span></div>
            </div>
            <div class="stats-grid">
                <div class="percentage-circle-container ${student.hasFailure ? 'has-failure' : ''}">
                    <svg viewBox="0 0 150 150"><circle class="circle-bg" cx="75" cy="75" r="65"></circle><circle class="circle-progress" cx="75" cy="75" r="65"></circle></svg>
                    <div class="percentage-text">0%</div>
                </div>
                <div class="rank-item"><p>${t.rank}</p><span class="rank-normal">#${student.rank}</span><p>${t.rankSubtitle.replace('{total}', student.totalStudentsInRank)}</p></div>
            </div>
            <div class="subject-bars-container">
                <h3>${t.subjectsLevel}</h3>
                ${student.grades.map(g => `<div class="subject-bar"><div class="subject-bar-info"><span>${g.subject}</span><span>${g.score}/${g.maxScore} ${g.failed ? `<span class="failed-label">(${t.fail})</span>` : ''}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill ${g.failed ? 'failed' : ''}" style="width:0%"></div></div></div>`).join('')}
            </div>
            <div id="chart-container"><canvas id="performanceChart"></canvas></div>`;
        
        setTimeout(() => {
            resultsContainer.classList.add('visible');
            animateCircle(student.percentage);
            document.querySelectorAll('.progress-bar-fill').forEach((el, i) => {
                const grade = student.grades[i];
                el.style.width = `${(grade.score / grade.maxScore) * 100}%`;
            });
            renderPerformanceChart(student);
            showFeedbackBanner(student);
        }, 50);
    }

    function animateCircle(percentage) {
        const circle = document.querySelector('.circle-progress');
        const radius = circle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        circle.style.strokeDasharray = `${circumference}`;
        circle.style.strokeDashoffset = circumference;
        setTimeout(() => circle.style.strokeDashoffset = circumference - (percentage / 100) * circumference, 100);
        animateValue(document.querySelector('.percentage-text'), 0, percentage, 1000, true);
    }

    function showFeedbackBanner(student) {
        const banner = document.getElementById('result-feedback-banner');
        const t = translations[currentLanguage];
        clearTimeout(feedbackTimeout);
        banner.className = 'result-feedback-banner';

        if (student.hasFailure) {
            const failedCount = student.grades.filter(g => g.failed).length;
            banner.innerHTML = `<p>${t.failedSubjectsMessage.replace('{count}', failedCount)}</p><button class="support-btn">${t.supportRequestBtn}</button>`;
            banner.classList.add('has-failure');
            banner.querySelector('button').onclick = () => showSupportModal(student);
        } else {
            banner.innerHTML = `<p>${t.successMessage}</p>`;
        }
        
        setTimeout(() => banner.classList.add('visible'), 100);
        feedbackTimeout = setTimeout(() => banner.classList.add('fade-out'), 8000);
    }

    function renderPerformanceChart(student) {
        if (performanceChart) performanceChart.destroy();
        const ctx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: student.grades.map(g => g.subject),
                datasets: [{ data: student.grades.map(g => (g.score / g.maxScore) * 100), backgroundColor: 'rgba(0, 255, 153, 0.2)', borderColor: 'rgb(0, 255, 153)', pointBackgroundColor: '#fff' }]
            },
            options: { maintainAspectRatio: false, scales: { r: { angleLines: { color: '#ffffff30' }, grid: { color: '#ffffff30' }, pointLabels: { color: '#e0e0e0', font: { size: 10 } }, suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    function displaySubjectAnalytics() {
        const container = document.getElementById('analytics-container');
        const t = translations[currentLanguage];
        container.innerHTML = `<div class="loading-message"><i class="fas fa-spinner fa-spin"></i> ${t.loadingAnalytics}</div>`;
        
        // Run analytics processing (simulates worker)
        if (Object.keys(subjectAnalyticsCache).length === 0) {
            processAnalytics();
        }
        
        // Render UI
        renderAnalyticsUI();
    }

    function renderAnalyticsUI() {
        const container = document.getElementById('analytics-container');
        container.innerHTML = '';
        const t = translations[currentLanguage];

        Object.keys(streamSummariesCache).forEach(streamName => {
            const streamData = streamSummariesCache[streamName];
            if (streamData.total === 0) return;

            const streamSection = document.createElement('div');
            streamSection.className = 'stream-section';
            streamSection.innerHTML = `
                <h2 class="stream-title"><i class="fas fa-stream"></i> ${t.streamPath} ${streamName}</h2>
                <div class="stream-summary-card">
                    <h3 class="stream-summary-title">${t.streamSummary}</h3>
                    <div class="stream-summary-stats">
                        <div class="stat-card"><h4>${t.passingStudents}</h4><div class="value">${streamData.passing}</div></div>
                        <div class="stat-card"><h4>${t.failingStudents}</h4><div class="value">${streamData.failing}</div></div>
                        <div class="stat-card"><h4>${t.totalStudents}</h4><div class="value">${streamData.total}</div></div>
                        <div class="stat-card"><h4>${t.passRate}</h4><div class="value">${((streamData.passing / streamData.total) * 100).toFixed(1)}%</div></div>
                    </div>
                    <div class="grade-distribution"><h3>${t.overallGradeDist}</h3><div class="histogram-container"><canvas id="stream-chart-${streamName}"></canvas></div></div>
                </div>`;
            
            const subjectsGrid = document.createElement('div');
            subjectsGrid.className = 'analytics-grid';
            
            Object.values(subjectAnalyticsCache).filter(s => s.stream === streamName).forEach(subject => {
                subjectsGrid.innerHTML += `
                <div class="subject-card">
                    <div class="subject-header"><h3 class="subject-title">${subject.subjectName}</h3></div>
                    <div class="subject-stats">
                        <div class="stat-card"><h4>${t.highestScore}</h4><div class="value">${subject.highestScore}</div></div>
                        <div class="stat-card"><h4>${t.lowestScore}</h4><div class="value">${subject.lowestScore}</div></div>
                        <div class="stat-card"><h4>${t.medianScore}</h4><div class="value">${subject.medianScore.toFixed(1)}</div></div>
                        <div class="stat-card"><h4>${t.studentCount}</h4><div class="value">${subject.passCount + subject.failCount}</div></div>
                    </div>
                    <div class="pass-fail-stats"><div class="pass-stat"><h4>${t.passingStudents}</h4><div class="value">${subject.passCount}</div></div><div class="fail-stat"><h4>${t.failingStudents}</h4><div class="value">${subject.failCount}</div></div></div>
                    <div class="grade-distribution"><h3>${t.successfulStudentDist}</h3><div class="histogram-container"><canvas id="chart-${subject.subjectName.replace(/\s/g,'')}-${streamName}"></canvas></div></div>
                </div>`;
            });
            
            streamSection.appendChild(subjectsGrid);
            container.appendChild(streamSection);
        });

        setTimeout(() => {
            Object.keys(streamSummariesCache).forEach(streamName => {
                if (streamSummariesCache[streamName].total > 0) {
                    renderStreamChart(streamName, streamSummariesCache[streamName].dist);
                    Object.values(subjectAnalyticsCache).filter(s => s.stream === streamName).forEach(renderSubjectChart);
                }
            });
        }, 100);
    }

    function renderStreamChart(streamName, data) {
        const ctx = document.getElementById(`stream-chart-${streamName}`).getContext('2d');
        const t = translations[currentLanguage];
        const gradeLabels = { "ممتاز": t.excellent, "جيد جداً": t.veryGood, "جيد": t.good, "مقبول": t.passGrade, "ضعيف": t.weak };
        new Chart(ctx, { type: 'bar', data: { labels: Object.keys(data).map(k => gradeLabels[k] || k), datasets: [{ data: Object.values(data), backgroundColor: 'rgba(0, 255, 153, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#aaa' }, grid: { color: '#ffffff1a' } }, x: { ticks: { color: '#aaa' } } } } });
    }

    function renderSubjectChart(subject) {
        const ctx = document.getElementById(`chart-${subject.subjectName.replace(/\s/g,'')}-${subject.stream}`).getContext('2d');
        new Chart(ctx, { type: 'bar', data: { labels: Object.keys(subject.gradeDistribution), datasets: [{ data: Object.values(subject.gradeDistribution), backgroundColor: 'rgba(166, 77, 255, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#aaa', stepSize: 1 }, grid: { color: '#ffffff1a' } }, x: { ticks: { color: '#aaa' } } } } });
    }

    // ==================== DASHBOARD & MODALS ====================
    function updateDashboard() {
        const allStudents = Object.values(studentResultsCache);
        if (allStudents.length === 0) return;
        const passing = allStudents.filter(s => !s.hasFailure).length;
        document.getElementById('total-students').textContent = allStudents.length;
        document.getElementById('passing-students').textContent = passing;
        document.getElementById('failing-students').textContent = allStudents.length - passing;
        document.getElementById('pass-rate').textContent = `${(passing / allStudents.length * 100).toFixed(1)}%`;
        populateSupportRequestsTable();
        
        const streamCounts = allStudents.reduce((acc, s) => ({...acc, [s.stream]: (acc[s.stream] || 0) + 1}), {});
        if (streamChart) streamChart.destroy();
        streamChart = new Chart(document.getElementById('streamChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(streamCounts), datasets: [{ data: Object.values(streamCounts), backgroundColor: ['rgba(0, 255, 153, 0.7)', 'rgba(77, 148, 255, 0.7)', 'rgba(255, 206, 86, 0.7)'], borderColor: '#0a0a0a' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#e0e0e0' } } } } });
    }

    function showSupportModal(student) {
        const failingSubjects = student.grades.filter(g => g.failed).map(g => g.subject).join(', ');
        document.getElementById('studentName').value = student.name;
        document.getElementById('failingSubjects').value = failingSubjects;
        document.getElementById('supportModal').classList.add('active');
    }

    function handleSupportRequest(e) {
        e.preventDefault();
        const studentNumberInput = document.getElementById('studentNumberInput').value;
        const request = {
            studentName: document.getElementById('studentName').value,
            studentNumber: studentNumberInput ? parseInt(studentNumberInput) : 'N/A',
            failingSubjects: document.getElementById('failingSubjects').value,
            city: document.getElementById('city').value,
            phone: document.getElementById('phone').value,
            status: "New",
            timestamp: new Date().toISOString()
        };
        supportRequests.push(request);
        localStorage.setItem('supportRequests', JSON.stringify(supportRequests));
        alert(translations[currentLanguage].supportRequestSent);
        document.getElementById('supportModal').classList.remove('active');
        if (currentPage === 'dashboard-page') populateSupportRequestsTable();
    }

    function populateSupportRequestsTable() {
        const tbody = document.getElementById('supportRequestsBody');
        tbody.innerHTML = supportRequests.map(req => `<tr><td>${req.studentName}</td><td>${req.studentNumber}</td><td>${req.failingSubjects}</td><td>${req.city}</td><td>${req.phone}</td><td>${new Date(req.timestamp).toLocaleDateString()}</td><td><span class="status-badge status-new">${translations[currentLanguage].statusNew}</span></td></tr>`).join('');
    }

    function exportSupportRequests() {
        let csv = "Student Name,Student Number,Failing Subjects,City,Phone,Request Date,Status\n";
        csv += supportRequests.map(r => `"${r.studentName}",${r.studentNumber},"${r.failingSubjects}","${r.city}",${r.phone},${new Date(r.timestamp).toISOString()},"New"`).join("\n");
        const link = document.createElement("a");
        link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        link.download = "support_requests.csv";
        link.click();
    }
    
    function animateValue(obj, start, end, duration, isPercent) {
        let startTimestamp;
        const step = ts => {
            if (!startTimestamp) startTimestamp = ts;
            const progress = Math.min((ts - startTimestamp) / duration, 1);
            const val = progress * (end - start) + start;
            obj.textContent = isPercent ? `${val.toFixed(1)}%` : Math.floor(val);
            if (progress < 1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
    }

    // ==================== INITIALIZATION & EVENT LISTENERS ====================
    function init() {
        // Data processing
        preCacheStudentResults();
        
        // Event Listeners
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', e => {
            e.preventDefault();
            loadPage(link.dataset.page);
            history.pushState({ page: link.dataset.page }, '', link.getAttribute('href'));
        }));
        window.addEventListener('popstate', () => loadPage(history.state?.page || 'home-page'));

        document.getElementById('searchButton').addEventListener('click', displayStudentResults);
        document.getElementById('studentNumberInput').addEventListener('keyup', e => e.key === 'Enter' && displayStudentResults());
        
        document.getElementById('languageToggle').addEventListener('click', e => {
            e.stopPropagation();
            document.getElementById('languageDropdown').classList.toggle('show');
        });
        document.querySelectorAll('.language-option').forEach(opt => opt.addEventListener('click', () => updateLanguage(opt.dataset.lang)));
        document.addEventListener('click', () => document.getElementById('languageDropdown').classList.remove('show'));

        // Dashboard access
        let clickCount = 0;
        document.getElementById('dashboardSecret').addEventListener('click', () => {
            clickCount++;
            setTimeout(() => clickCount = 0, 500);
            if (clickCount >= 2) {
                document.getElementById('password-modal').classList.add('active');
                document.getElementById('password-input').focus();
            }
        });
        const passwordInput = document.getElementById('password-input');
        const passwordBtn = document.getElementById('password-btn');
        const checkPassword = () => {
            if (passwordInput.value === DASHBOARD_PASSWORD) {
                document.getElementById('password-modal').classList.remove('active');
                loadPage('dashboard-page');
                history.pushState({ page: 'dashboard-page' }, '', '#dashboard');
            } else {
                document.getElementById('password-error').style.display = 'block';
                passwordInput.parentElement.classList.add('shake');
                setTimeout(() => passwordInput.parentElement.classList.remove('shake'), 500);
            }
        };
        passwordBtn.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keyup', e => e.key === 'Enter' && checkPassword());

        // Modals
        document.getElementById('supportForm').addEventListener('submit', handleSupportRequest);
        document.getElementById('modalClose').addEventListener('click', () => document.getElementById('supportModal').classList.remove('active'));
        document.getElementById('cancelSupport').addEventListener('click', () => document.getElementById('supportModal').classList.remove('active'));
        document.getElementById('exportRequestsBtn').addEventListener('click', exportSupportRequests);

        // Initial Load
        updateLanguage(currentLanguage);
        const hash = window.location.hash.slice(1);
        if (hash === 'dashboard') {
             document.getElementById('password-modal').classList.add('active');
        } else {
            loadPage(hash === 'analytics' ? 'analytics-page' : (hash === 'about' ? 'about-page' : 'home-page'));
        }
    }

    init();
});
</script>
</body>
</html>
